
with reportsum as (
        select restaurantid, sum(cleanrank) as cleansum,
           sum(busyrank) as busysum
    from finalizedreports
      where date_trunc('week',submissiontime) >= 
            date_trunc('week',CURRENT_TIMESTAMP) - interval '1 week'
    group by restaurantid
    ),
    counter as (
    select restaurantid, count(*) as totalreports
    from finalizedreports
      where date_trunc('week',submissiontime) >= 
            date_trunc('week',CURRENT_TIMESTAMP) - interval '1 week'
    group by restaurantid
    )
    select
      rs.restaurantid,
      ROUND(rs.cleansum / (c.totalreports),2) as cleanavg, 
      ROUND(rs.busysum / (c.totalreports),2) as busyavg,
      ROUND((((rs.cleansum /c.totalreports)+ (rs.cleansum / c.totalreports) * 5)) / 2, 2) as algclean,
      ROUND((((rs.busysum /c.totalreports) + (rs.busysum / c.totalreports) * 5)) / 2, 2) as algbusy
    from reportsum as rs
      inner join counter as c using (restaurantid)
      inner join finalizedreports as fr using (restaurantid)
    where rs.restaurantid = 1
    group by rs.restaurantid, cleanavg, busyavg, algclean, algbusy
    ;
    
    with reportsum as (
    select restaurantid, sum(cleanrank) as cleansum,
           sum(busyrank) as busysum
    from finalizedreports
      where date_trunc('week',submissiontime) >= 
            date_trunc('week',CURRENT_TIMESTAMP) - interval '1 week'
    group by restaurantid
    ),
    counter as (
    select restaurantid, count(*) as totalreports
    from finalizedreports
      where date_trunc('week',submissiontime) >= 
            date_trunc('week',CURRENT_TIMESTAMP) - interval '1 week'
    group by restaurantid
    )
    select
      rs.restaurantid,
      ROUND(rs.cleansum / (c.totalreports),2) as cleanavg, 
      ROUND(rs.busysum / (c.totalreports),2) as busyavg
    from reportsum as rs
      inner join counter as c using (restaurantid)
      inner join finalizedreports as fr using (restaurantid)
    group by rs.restaurantid, cleanavg, busyavg
    ;

-- get reports per restaurant and sort by DOW and TimeOfDay
with reports as(
select restaurantid, cleanrank as crank, busyrank as brank, submissiontime as stime,
  to_char(submissiontime, 'ID') as dowtime, -- Monday(1) Sunday(7)
  to_char(submissiontime, 'HH24') as timeofday -- 00 - 24 | 05 - 11 Breakfast, 11 - 17 Lunch, 18 - 22 Dinner, 23-04 Other
from finalizedreports
),
countday as (
  select restaurantid,
    round(avg(crank),2) as cleanavg, 
    round(avg(brank),2) as busyavg,
    dowtime
  from reports 
  group by dowtime, restaurantid
  order by restaurantid, dowtime
)
select *
from countday
where dowtime = to_char(CURRENT_TIMESTAMP, 'ID') AND
      restaurantid = $1;




--
reportsperday as (
select id, count(*) as totalreportsday, dowtime
from reports
group by dowtime
order by totalreportsday
),



--insert into finalizedreports values
(1000, 1, 1, 5.0, false, '2022-11-28 05:59:53-05'),
(01001, 1, 2, 3.5, false, '2022-11-28 11:59:53-05'),
(01002, 1, 2, 4.5, false, '2022-11-28 18:59:53-05'),
(01010, 2, 1, 5.0, false, '2022-11-28 05:59:53-05'),
(01011, 2, 2, 3.5, false, '2022-11-28 11:59:53-05'),
(01012, 2, 2, 4.5, false, '2022-11-28 18:59:53-05'),
(01020, 3, 1, 5.0, false, '2022-11-28 05:59:53-05'),
(01021, 3, 2, 3.5, false, '2022-11-28 11:59:53-05'),
(01022, 3, 2, 4.5, false, '2022-11-28 18:59:53-05'),
(01030, 4, 1, 5.0, false, '2022-11-28 05:59:53-05'),
(01031, 4, 2, 3.5, false, '2022-11-28 11:59:53-05'),
(01032, 4, 2, 4.5, false, '2022-11-28 18:59:53-05'),
(01040, 5, 1, 5.0, false, '2022-11-28 05:59:53-05'),
(01041, 5, 2, 3.5, false, '2022-11-28 11:59:53-05'),
(01042, 5, 2, 4.5, false, '2022-11-28 18:59:53-05'),
(01050, 6, 1, 5.0, false, '2022-11-28 05:59:53-05'),
(01051, 6, 2, 3.5, false, '2022-11-28 11:59:53-05'),
(01052, 6, 2, 4.5, false, '2022-11-28 18:59:53-05'),
(01060, 7, 1, 5.0, false, '2022-11-28 05:59:53-05'),
(01061, 7, 2, 3.5, false, '2022-11-28 11:59:53-05'),
(01062, 7, 2, 4.5, false, '2022-11-28 18:59:53-05'),
--
(01100, 1, 1, 5.0, false, '2022-11-29 05:59:53-05'),
(01101, 1, 2, 3.5, false, '2022-11-29 11:59:53-05'),
(01102, 1, 2, 4.5, false, '2022-11-29 18:59:53-05'),
(01110, 2, 1, 5.0, false, '2022-11-29 05:59:53-05'),
(01111, 2, 2, 3.5, false, '2022-11-29 11:59:53-05'),
(01112, 2, 2, 4.5, false, '2022-11-29 18:59:53-05'),
(01120, 3, 1, 5.0, false, '2022-11-29 05:59:53-05'),
(01121, 3, 2, 3.5, false, '2022-11-29 11:59:53-05'),
(01122, 3, 2, 4.5, false, '2022-11-29 18:59:53-05'),
(01130, 4, 1, 5.0, false, '2022-11-29 05:59:53-05'),
(01131, 4, 2, 3.5, false, '2022-11-29 11:59:53-05'),
(01132, 4, 2, 4.5, false, '2022-11-29 18:59:53-05'),
(01140, 5, 1, 5.0, false, '2022-11-29 05:59:53-05'),
(01141, 5, 2, 3.5, false, '2022-11-29 11:59:53-05'),
(01142, 5, 2, 4.5, false, '2022-11-29 18:59:53-05'),
(01150, 6, 1, 5.0, false, '2022-11-29 05:59:53-05'),
(01151, 6, 2, 3.5, false, '2022-11-29 11:59:53-05'),
(01152, 6, 2, 4.5, false, '2022-11-29 18:59:53-05'),
(01160, 7, 1, 5.0, false, '2022-11-29 05:59:53-05'),
(01161, 7, 2, 3.5, false, '2022-11-29 11:59:53-05'),
(01162, 7, 2, 4.5, false, '2022-11-29 18:59:53-05'),
--
(02100, 1, 1, 5.0, false, '2022-11-30 05:59:53-05'),
(02101, 1, 2, 3.5, false, '2022-11-30 11:59:53-05'),
(02102, 1, 2, 4.5, false, '2022-11-30 18:59:53-05'),
(02110, 2, 1, 5.0, false, '2022-11-30 05:59:53-05'),
(02111, 2, 2, 3.5, false, '2022-11-30 11:59:53-05'),
(02112, 2, 2, 4.5, false, '2022-11-30 18:59:53-05'),
(02120, 3, 1, 5.0, false, '2022-11-30 05:59:53-05'),
(02121, 3, 2, 3.5, false, '2022-11-30 11:59:53-05'),
(02122, 3, 2, 4.5, false, '2022-11-30 18:59:53-05'),
(02130, 4, 1, 5.0, false, '2022-11-30 05:59:53-05'),
(02131, 4, 2, 3.5, false, '2022-11-30 11:59:53-05'),
(02132, 4, 2, 4.5, false, '2022-11-30 18:59:53-05'),
(02140, 5, 1, 5.0, false, '2022-11-30 05:59:53-05'),
(02141, 5, 2, 3.5, false, '2022-11-30 11:59:53-05'),
(02142, 5, 2, 4.5, false, '2022-11-30 18:59:53-05'),
(02150, 6, 1, 5.0, false, '2022-11-30 05:59:53-05'),
(02151, 6, 2, 3.5, false, '2022-11-30 11:59:53-05'),
(02152, 6, 2, 4.5, false, '2022-11-30 18:59:53-05'),
(02160, 7, 1, 5.0, false, '2022-11-30 05:59:53-05'),
(02161, 7, 2, 3.5, false, '2022-11-30 11:59:53-05'),
(02162, 7, 2, 4.5, false, '2022-11-30 18:59:53-05'),
--
(03100, 1, 1, 5.0, false, '2022-12-01 05:59:53-05'),
(03101, 1, 2, 3.5, false, '2022-12-01 11:59:53-05'),
(03102, 1, 2, 4.5, false, '2022-12-01 18:59:53-05'),
(03110, 2, 1, 5.0, false, '2022-12-01 05:59:53-05'),
(03111, 2, 2, 3.5, false, '2022-12-01 11:59:53-05'),
(03112, 2, 2, 4.5, false, '2022-12-01 18:59:53-05'),
(03120, 3, 1, 5.0, false, '2022-12-01 05:59:53-05'),
(03121, 3, 2, 3.5, false, '2022-12-01 11:59:53-05'),
(03122, 3, 2, 4.5, false, '2022-12-01 18:59:53-05'),
(03130, 4, 1, 5.0, false, '2022-12-01 05:59:53-05'),
(03131, 4, 2, 3.5, false, '2022-12-01 11:59:53-05'),
(03132, 4, 2, 4.5, false, '2022-12-01 18:59:53-05'),
(03140, 5, 1, 5.0, false, '2022-12-01 05:59:53-05'),
(03141, 5, 2, 3.5, false, '2022-12-01 11:59:53-05'),
(03142, 5, 2, 4.5, false, '2022-12-01 18:59:53-05'),
(03150, 6, 1, 5.0, false, '2022-12-01 05:59:53-05'),
(03151, 6, 2, 3.5, false, '2022-12-01 11:59:53-05'),
(03152, 6, 2, 4.5, false, '2022-12-01 18:59:53-05'),
(03160, 7, 1, 5.0, false, '2022-12-01 05:59:53-05'),
(03161, 7, 2, 3.5, false, '2022-12-01 11:59:53-05'),
(03162, 7, 2, 4.5, false, '2022-12-01 18:59:53-05'),
--
(04100, 1, 1, 5.0, false, '2022-12-02 05:59:53-05'),
(04101, 1, 2, 3.5, false, '2022-12-02 11:59:53-05'),
(04102, 1, 2, 4.5, false, '2022-12-02 18:59:53-05'),
(04110, 2, 1, 5.0, false, '2022-12-02 05:59:53-05'),
(04111, 2, 2, 3.5, false, '2022-12-02 11:59:53-05'),
(04112, 2, 2, 4.5, false, '2022-12-02 18:59:53-05'),
(04120, 3, 1, 5.0, false, '2022-12-02 05:59:53-05'),
(04121, 3, 2, 3.5, false, '2022-12-02 11:59:53-05'),
(04122, 3, 2, 4.5, false, '2022-12-02 18:59:53-05'),
(04130, 4, 1, 5.0, false, '2022-12-02 05:59:53-05'),
(04131, 4, 2, 3.5, false, '2022-12-02 11:59:53-05'),
(04132, 4, 2, 4.5, false, '2022-12-02 18:59:53-05'),
(04140, 5, 1, 5.0, false, '2022-12-02 05:59:53-05'),
(04141, 5, 2, 3.5, false, '2022-12-02 11:59:53-05'),
(04142, 5, 2, 4.5, false, '2022-12-02 18:59:53-05'),
(04150, 6, 1, 5.0, false, '2022-12-02 05:59:53-05'),
(04151, 6, 2, 3.5, false, '2022-12-02 11:59:53-05'),
(04152, 6, 2, 4.5, false, '2022-12-02 18:59:53-05'),
(04160, 7, 1, 5.0, false, '2022-12-02 05:59:53-05'),
(04161, 7, 2, 3.5, false, '2022-12-02 11:59:53-05'),
(04162, 7, 2, 4.5, false, '2022-12-02 18:59:53-05'),
--
(05100, 1, 1, 5.0, false, '2022-12-03 05:59:53-05'),
(05101, 1, 2, 3.5, false, '2022-12-03 11:59:53-05'),
(05102, 1, 2, 4.5, false, '2022-12-03 18:59:53-05'),
(05110, 2, 1, 5.0, false, '2022-12-03 05:59:53-05'),
(05111, 2, 2, 3.5, false, '2022-12-03 11:59:53-05'),
(05112, 2, 2, 4.5, false, '2022-12-03 18:59:53-05'),
(05120, 3, 1, 5.0, false, '2022-12-03 05:59:53-05'),
(05121, 3, 2, 3.5, false, '2022-12-03 11:59:53-05'),
(05122, 3, 2, 4.5, false, '2022-12-03 18:59:53-05'),
(05130, 4, 1, 5.0, false, '2022-12-03 05:59:53-05'),
(05131, 4, 2, 3.5, false, '2022-12-03 11:59:53-05'),
(05132, 4, 2, 4.5, false, '2022-12-03 18:59:53-05'),
(05140, 5, 1, 5.0, false, '2022-12-03 05:59:53-05'),
(05141, 5, 2, 3.5, false, '2022-12-03 11:59:53-05'),
(05142, 5, 2, 4.5, false, '2022-12-03 18:59:53-05'),
(05150, 6, 1, 5.0, false, '2022-12-03 05:59:53-05'),
(05151, 6, 2, 3.5, false, '2022-12-03 11:59:53-05'),
(05152, 6, 2, 4.5, false, '2022-12-03 18:59:53-05'),
(05160, 7, 1, 5.0, false, '2022-12-03 05:59:53-05'),
(05161, 7, 2, 3.5, false, '2022-12-03 11:59:53-05'),
(05162, 7, 2, 4.5, false, '2022-12-03 18:59:53-05'),
--
(06100, 1, 1, 5.0, false, '2022-12-04 05:59:53-05'),
(06101, 1, 2, 3.5, false, '2022-12-04 11:59:53-05'),
(06102, 1, 2, 4.5, false, '2022-12-04 18:59:53-05'),
(06110, 2, 1, 5.0, false, '2022-12-04 05:59:53-05'),
(06111, 2, 2, 3.5, false, '2022-12-04 11:59:53-05'),
(06112, 2, 2, 4.5, false, '2022-12-04 18:59:53-05'),
(06120, 3, 1, 5.0, false, '2022-12-04 05:59:53-05'),
(06121, 3, 2, 3.5, false, '2022-12-04 11:59:53-05'),
(06122, 3, 2, 4.5, false, '2022-12-04 18:59:53-05'),
(06130, 4, 1, 5.0, false, '2022-12-04 05:59:53-05'),
(06131, 4, 2, 3.5, false, '2022-12-04 11:59:53-05'),
(06132, 4, 2, 4.5, false, '2022-12-04 18:59:53-05'),
(06140, 5, 1, 5.0, false, '2022-12-04 05:59:53-05'),
(06141, 5, 2, 3.5, false, '2022-12-04 11:59:53-05'),
(06142, 5, 2, 4.5, false, '2022-12-04 18:59:53-05'),
(06150, 6, 1, 5.0, false, '2022-12-04 05:59:53-05'),
(06151, 6, 2, 3.5, false, '2022-12-04 11:59:53-05'),
(06152, 6, 2, 4.5, false, '2022-12-04 18:59:53-05'),
(06160, 7, 1, 5.0, false, '2022-12-04 05:59:53-05'),
(06161, 7, 2, 3.5, false, '2022-12-04 11:59:53-05'),
(06162, 7, 2, 4.5, false, '2022-12-04 18:59:53-05');